import pandas as pd
import plotly.express as px
import io

# 1. Definición del archivo de entrada ÚNICO
input_file = 'Consolidado_Tickets_Final.csv'

try:
    # 2. Lectura del archivo consolidado (se asume que ya fue limpiado previamente)
    # Usamos encoding 'latin-1' y sep=',' como medida de seguridad
    try:
        df_final = pd.read_csv(input_file, sep=',', encoding='latin-1', on_bad_lines='skip')
    except:
        df_final = pd.read_csv(input_file, sep=';', encoding='latin-1', on_bad_lines='skip')

    # Aseguramos que 'Monto' sea numérico y 'Estado' exista
    if 'Monto' not in df_final.columns or 'Estado' not in df_final.columns:
         raise ValueError("El archivo no contiene las columnas 'Monto' o 'Estado'.")

    # Forzar la conversión de Monto (por si Looker Studio lo lee mal)
    df_final['Monto'] = pd.to_numeric(df_final['Monto'], errors='coerce').fillna(0)
    df_final['Volumen'] = 1
    
    # 3. Clasificación de Secciones (La lógica validada en Sheets)
    def clasificar_acceso(acceso):
        acceso_mayus = str(acceso).upper()
        if 'CENTENARIO' in acceso_mayus:
            return 'CENTENARIO'
        elif 'FAVALORO' in acceso_mayus:
            return 'FAVALORO'
        elif 'BASILE' in acceso_mayus:
            return 'BASILE'
        elif 'AVENIDA 60' in acceso_mayus:
            return 'AVENIDA 60'
        else:
            return 'OTROS/GENERALES'

    df_final['SECCION_CLASIFICADA'] = df_final['Acceso'].apply(clasificar_acceso)
    
    # Filtrar solo tickets 'CONFIRMADO' para el análisis final
    df_confirmado = df_final[df_final['Estado'].str.strip().str.upper() == 'CONFIRMADO'].copy()
    
    if df_confirmado.empty:
        raise ValueError("No se encontraron registros 'CONFIRMADO' para analizar.")

    # --- Generación Automática de Gráficos (Plotly) ---

    # KPI 1: Ingreso Total
    total_monto = df_confirmado['Monto'].sum()
    total_volumen = df_confirmado.shape[0]

    # Gráfico 1: Ingreso por Origen (Circular)
    df_origen_monto = df_confirmado.groupby('Origen')['Monto'].sum().reset_index()
    fig1 = px.pie(df_origen_monto, values='Monto', names='Origen', title='1. Distribución de Ingresos Netos por Origen',
                  hole=0.3, color_discrete_sequence=px.colors.qualitative.Bold)

    # Gráfico 2: Volumen por Sección (Barras)
    df_seccion_volumen = df_confirmado.groupby('SECCION_CLASIFICADA')['Volumen'].count().reset_index()
    fig2 = px.bar(df_seccion_volumen, x='SECCION_CLASIFICADA', y='Volumen', 
                  title='2. Volumen de Tickets Confirmados por Sección',
                  color='SECCION_CLASIFICADA')

    # Gráfico 3: Análisis de Ingreso por Origen en cada Sección (Apilado)
    fig3 = px.bar(df_confirmado, x='SECCION_CLASIFICADA', y='Monto', color='Origen',
                  title='3. Ingreso Total por Sección y Desglose por Origen')

    # --- Generación del HTML Final ---
    
    html_content = f"""
    <html><head><title>Dashboard Dinámico de Tickets (Automático)</title>...</head>
    <body>
        <h1>ANÁLISIS AUTOMÁTICO DE VENTA DE TICKETS</h1>
        <div style="display: flex; justify-content: space-around;">
            <div style="text-align: center;"><h2>INGRESO TOTAL NETO</h2><p style="font-size: 2em; font-weight: bold;">${total_monto:,.2f}</p></div>
            <div style="text-align: center;"><h2>VOLUMEN DE TICKETS</h2><p style="font-size: 2em; font-weight: bold;">{total_volumen:,}</p></div>
        </div>
        {fig1.to_html(full_html=False, include_plotlyjs='cdn')}
        {fig2.to_html(full_html=False, include_plotlyjs='cdn')}
        {fig3.to_html(full_html=False, include_plotlyjs='cdn')}
    </body></html>
    """

    output_filename = 'Dashboard_Tickets_Interactivo.html'
    with open(output_filename, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"✅ Proceso COMPLETADO. Archivo HTML generado: {output_filename}")

except FileNotFoundError:
    print(f"❌ ERROR: No se encontró el archivo '{input_file}'. Asegúrate de haberlo subido al entorno de ejecución.")
except ValueError as e:
    print(f"❌ ERROR DE DATOS: {e}")
except Exception as e:
    print(f"❌ ERROR DESCONOCIDO: {e}")
